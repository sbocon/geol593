P3
================
Sam Ocon

Here, I’m loading in all the libraries I will be using for cleaning up
and analyzing the resulting data. Specifically:

-   The tidyverse is a great tool for wrangling data, so I will be using
    it to filter + format data

-   Claddis (and the required packages it imports) will be used to
    wrangle the phylogenetic data

<!-- -->

    library(tidyverse)

    ## -- Attaching packages --------------------------------------- tidyverse 1.3.0 --

    ## v ggplot2 3.3.3     v purrr   0.3.4
    ## v tibble  3.1.0     v dplyr   1.0.5
    ## v tidyr   1.1.3     v stringr 1.4.0
    ## v readr   1.4.0     v forcats 0.5.1

    ## -- Conflicts ------------------------------------------ tidyverse_conflicts() --
    ## x dplyr::filter() masks stats::filter()
    ## x dplyr::lag()    masks stats::lag()

    library(Claddis)

    ## Loading required package: ape

    ## Loading required package: phytools

    ## Loading required package: maps

    ## 
    ## Attaching package: 'maps'

    ## The following object is masked from 'package:purrr':
    ## 
    ##     map

    ## Loading required package: strap

    ## Loading required package: geoscale

Okay, now for the fun part; let’s start by reading in the results of the
last analysis.

    #Reading in the results of our last analysis
    load("Data/RateCalculations_500.RData")

Since these are in a list format, they’re really hard to plot! What I
want are the inferred changes for each tree, so I can calculate
patristic dissimilarity.

    #Start by writing a function that will count the number of state changes per branch in the tree; dplyr needs data frames, so first I convert, then I group the numbers by edge and count the number of times a change happens on a specific branch; finally, it outputs that as a data frame
    makeChangeMatrix <- function(tree){
      as.data.frame(tree[["inferred_character_changes"]]) %>%
      group_by(edge) %>% count() %>% as.data.frame()
    }

Okay, so now I need to apply that to the entire list of trees so I have
one of these data frames for each of the trees.

    #Just applying my function to every tree (item) in the rate calculations list and assigning it to an output
    changespertree <- lapply(rate.calculations, makeChangeMatrix)

Now I need to divide these values by the “comparable characters” of each
branch, a number which is calculated by taking the number of missing
traits per branch and subtracting that from the total amount of
characters scored. In the paper I’m basing this on, Brusatte uses 0
missing for the internal branches, so I will do the same.

    #Read in cladistic matrix
    clad.matrix <- read_nexus_matrix("Data/Xiph_Matrix_Claddis.nex")

    #Okay, now subtract the number of missing characters from the total number of traits scored. 

    #The apply function is basically checking where there are NA values and then counting them for me
    CompChar <- 259 - apply(apply(clad.matrix$matrix_1$matrix, 2, is.na), 1, sum)

    CompChar <- as.data.frame(CompChar)
    CompChar$names <- rownames(CompChar)

Now I need to divide the number of changes by the comparable characters
per branch, which is most complicated for the terminal branches (ones
that end in an taxon)

    #Okay, now I need to swap from taxon names to branch names
    return_tax_edges <- function(tree, changes){
      #Make list of tip labels
      labs <- tree$time_tree$tip.label
      #Make a key of branches that have taxa on them
      key <- sapply(labs, which.edge, phy=tree$time_tree)
      key <- as.data.frame(key)
      key$names <- rownames(key)
      #Make a matrix of matches and names!
      edges <- merge(changes, key, by.x="edge", by.y="key", all.x = TRUE)
      return(edges)
    }

    #I'd also like to add their habitats, age, and clade back onto the final dataset, so I'm going to make a key

    info <- read.csv("Data/HS_info.csv")

Now that we have our function, let’s apply it!

    #Create empty list to store the results
    tax_edges <- list()
    #Okay, now loop through and generate a list of these edge matrices
    for(i in 1:length(rate.calculations)){
      edges <- return_tax_edges(rate.calculations[[i]], changespertree[[i]])
      # I also want to add in the comparable character value so I can really      easily populate a new column with the patristic dissimilarity matrix!
      edges <- merge(edges, CompChar, by="names", all.x=TRUE)
      #Adding in internal branch names to remove NAs
      edges$names <- ifelse(is.na(edges$names), paste("Branch", edges$edge), 
                            edges$names)
      #I also want to add in 259s in the CompChar column for the internal branches
      edges$CompChar <- ifelse(is.na(edges$CompChar), 259, edges$CompChar)
      #Finally, gotta add in the duration of each branch. It wouldn't let me turn this into a function so we're doing it this way
        #pull out the branch lengths (in millions of years)
      brlen <- as.data.frame(rate.calculations[[i]]$time_tree$edge.length)
      #name the column to something easier
      colnames(brlen) <- "duration"
      #Make a column of edge names so it is easy to tack on
      brlen$edge <- rownames(brlen)
      
      #add durations on
      edges <- merge(edges, brlen, by="edge")
      
      #Add in info!
      edges <- merge(edges, info, by.x="names", by.y="X", all.x=TRUE)
      
      tax_edges <- append(tax_edges, list(edges))
    }

Now for the math!

Patristic Dissimilarity = number of changes / comparable characters

Rate of Evolution = Patristic Dissimilarity / Time Duration

Let’s do that step by step, so I have both columns, just in case!

    #Adding in new columns calculated from others
    brusatte_rate_calc <- lapply(tax_edges, function(x) {
        mutate(x,
               pd=n/CompChar,
               rate=pd/duration)})

    #let's see what it looks like!
    head(brusatte_rate_calc[[1]])

    ##                            names edge  n CompChar duration   fad   lad    mid
    ## 1          Anacontium_carpenteri   15 13       39 49.84211 295.0 272.3 283.65
    ## 2               Andersoniella_sp   22  1      168 24.33197 323.2 298.9 311.05
    ## 3 Batracholimulus_fuchsbergensis   87  1      103 44.18205 237.0 201.3 219.15
    ## 4        Belinurus_trilobitoides   24  3      111 25.23760 323.2 298.9 311.05
    ## 5                       Branch 1    1  7      259 69.58426    NA    NA     NA
    ## 6                      Branch 10   10  1      259  1.00000    NA    NA     NA
    ##      habitat           clade heterochrony          pd         rate
    ## 1 non-marine     bellinurina         -0.5 0.333333333 0.0066877853
    ## 2 non-marine     bellinurina         -0.5 0.005952381 0.0002446321
    ## 3 non-marine austrolimulidae  0.444444444 0.009708738 0.0002197439
    ## 4 non-marine     bellinurina -0.352941176 0.027027027 0.0010709032
    ## 5       <NA>            <NA>         <NA> 0.027027027 0.0003884072
    ## 6       <NA>            <NA>         <NA> 0.003861004 0.0038610039

    #Okay, let's save this so I don't have to run it again :)
    save(brusatte_rate_calc, file="Data/rate_by_hand.RData")

Yay! We have evolutionary rates! I want them to be easier to read in, so
I’m going to convert them from a list to a csv. This will take a few
steps.

    #Make empty data frame to store the results
    rate_by_hand <- data.frame()
    #First, I want to add in their tree number as a column
    for(i in 1:length(brusatte_rate_calc)){
     brusatte_rate_calc[[i]]$tree <- paste("tree", i)
     
    #Then, I want to paste them all together, to remove the list structure
      rate_by_hand <- bind_rows(rate_by_hand, brusatte_rate_calc[[i]] )
    }

    #export it!
    write.csv(rate_by_hand, "rate_by_hand.csv")
[Previous (Page 2)](https://sbocon.github.io/geol593/P2) | [Next (Page 4)](https://sbocon.github.io/geol593/P4)

### All links:
[Home](https://sbocon.github.io/geol593/)

[Page 1](https://sbocon.github.io/geol593/P1)

[Page 2](https://sbocon.github.io/geol593/P2)

[Page 3](https://sbocon.github.io/geol593/P3)

[Page 4](https://sbocon.github.io/geol593/P4)
